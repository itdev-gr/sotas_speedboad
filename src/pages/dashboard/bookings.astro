---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---
<DashboardLayout title="Bookings">
	<h1>Bookings</h1>
	<div class="dash-card">
		<h2 style="margin-top: 0; font-size: 1.1rem;">New booking</h2>
		<form id="booking-form" class="dash-form booking-form-grid">
			<div class="dash-field">
				<label>Customer name</label>
				<input type="text" name="customerName" required />
			</div>
			<div class="dash-field">
				<label>Email</label>
				<input type="email" name="email" id="booking-email" />
			</div>
			<div class="dash-field">
				<label>Phone</label>
				<input type="text" name="phone" id="booking-phone" />
			</div>
			<div class="dash-field">
				<label>Scooter</label>
				<select name="scooterId">
					<option value="sh-125">SH 125</option>
					<option value="liberty-125">LIBERTY 125</option>
					<option value="sim-200">SIM 200</option>
					<option value="voge-rally-300">VOGE RALLY 300</option>
				</select>
			</div>
			<div class="dash-field">
				<label>Pickup date</label>
				<input type="date" name="pickupDate" required />
			</div>
			<div class="dash-field">
				<label>Return date</label>
				<input type="date" name="returnDate" required />
			</div>
			<div class="dash-field">
				<label>Pickup location</label>
				<select name="pickupLocationId" id="pickup-loc"></select>
			</div>
			<div class="dash-field">
				<label>Return location</label>
				<select name="returnLocationId" id="return-loc"></select>
			</div>
			<div class="dash-field">
				<label>Total (€)</label>
				<input type="number" name="totalEur" step="0.01" min="0" value="0" />
			</div>
			<div class="dash-field">
				<label>Status</label>
				<select name="status">
					<option value="pending">Pending</option>
					<option value="completed">Completed</option>
					<option value="cancelled">Cancelled</option>
				</select>
			</div>
			<div class="dash-field" style="grid-column: 1 / -1;">
				<label>Notes</label>
				<textarea name="notes" style="max-width: 100%;"></textarea>
			</div>
			<div style="grid-column: 1 / -1;">
				<button type="submit" class="dash-btn">Create booking</button>
			</div>
		</form>
		<p id="booking-form-msg" style="margin-top: 0.75rem; font-size: 0.9rem; color: #666;"></p>
	</div>
	<style>
		.booking-form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 0.75rem 1.25rem;
		}
		.booking-form-grid .dash-field {
			margin-bottom: 0;
		}
		.booking-form-grid input,
		.booking-form-grid select,
		.booking-form-grid textarea {
			max-width: 100%;
		}
	</style>
	<div class="dash-card">
		<h2 style="margin-top: 0; font-size: 1.1rem;">All bookings</h2>
		<table class="dash-table" id="bookings-table">
			<thead>
				<tr>
					<th>Customer</th>
					<th>Scooter</th>
					<th>Pickup</th>
					<th>Return</th>
					<th>Total</th>
					<th>Status</th>
				</tr>
			</thead>
			<tbody id="bookings-tbody">
				<tr><td colspan="6">Loading…</td></tr>
			</tbody>
		</table>
	</div>
	<script>
		function escapeHtml(s) {
			const div = document.createElement('div');
			div.textContent = s ?? '';
			return div.innerHTML;
		}

		function getSeason(dateStr) {
			const d = new Date(dateStr);
			const month = d.getMonth() + 1;
			const day = d.getDate();
			if (month < 6) return 'low';
			if (month > 9) return 'low';
			if (month === 6 && day < 15) return 'low';
			if (month === 9 && day > 30) return 'low';
			return 'high';
		}

		function getDays(pickupDate, returnDate) {
			if (!pickupDate || !returnDate) return null;
			const a = new Date(pickupDate);
			const b = new Date(returnDate);
			if (isNaN(a.getTime()) || isNaN(b.getTime()) || b < a) return null;
			const diff = Math.round((b.getTime() - a.getTime()) / (24 * 60 * 60 * 1000));
			return diff < 1 ? 1 : diff;
		}

		function getRentalPrice(pricesMatrix, scooterId, season, days) {
			if (!scooterId || !season || !days || days < 1) return 0;
			if (days <= 7) {
				const row = pricesMatrix.find(function (p) {
					return p.scooter_id === scooterId && p.season === season && p.days === days;
				});
				return row ? Number(row.price_eur) : 0;
			}
			// > 7 days: 7-day price + (price7 / 7) * extra days
			const row7 = pricesMatrix.find(function (p) {
				return p.scooter_id === scooterId && p.season === season && p.days === 7;
			});
			const price7 = row7 ? Number(row7.price_eur) : 0;
			if (price7 === 0) return 0;
			const dailyRate = price7 / 7;
			const extraDays = days - 7;
			return price7 + (dailyRate * extraDays);
		}

		function getLocationPrice(locations, locationId) {
			if (!locationId) return 0;
			const loc = locations.find(function (l) { return l.id === locationId; });
			return (loc && loc.price_eur != null) ? Number(loc.price_eur) : 0;
		}

		(async () => {
			const form = document.getElementById('booking-form');
			const formMsg = document.getElementById('booking-form-msg');
			const tbody = document.getElementById('bookings-tbody');
			const pickupSelect = document.getElementById('pickup-loc');
			const returnSelect = document.getElementById('return-loc');
			const totalInput = form?.querySelector('[name="totalEur"]');
			const scooterSelect = form?.querySelector('[name="scooterId"]');
			const pickupDateInput = form?.querySelector('[name="pickupDate"]');
			const returnDateInput = form?.querySelector('[name="returnDate"]');

			// Load locations
			const locRes = await fetch('/api/locations', { credentials: 'include' });
			const locations = locRes.ok ? await locRes.json() : [];
			locations.forEach((loc) => {
				const opt = document.createElement('option');
				opt.value = loc.id;
				opt.textContent = loc.label || loc.id;
				pickupSelect?.appendChild(opt.cloneNode(true));
				returnSelect?.appendChild(opt);
			});

			// Load prices matrix
			const pricesRes = await fetch('/api/prices', { credentials: 'include' });
			const pricesMatrix = pricesRes.ok ? await pricesRes.json() : [];

			// Auto-calc total
			function calcTotal() {
				if (!totalInput || !scooterSelect || !pickupDateInput || !returnDateInput) return;
				const scooterId = (scooterSelect as HTMLSelectElement).value;
				const pickupDate = (pickupDateInput as HTMLInputElement).value;
				const returnDate = (returnDateInput as HTMLInputElement).value;
				const pickupLocId = (pickupSelect as HTMLSelectElement)?.value ?? '';
				const returnLocId = (returnSelect as HTMLSelectElement)?.value ?? '';
				const days = getDays(pickupDate, returnDate);
				if (!days) return;
				const season = getSeason(pickupDate);
				const rental = getRentalPrice(pricesMatrix, scooterId, season, days);
				const pickupLocPrice = getLocationPrice(locations, pickupLocId);
				const returnLocPrice = getLocationPrice(locations, returnLocId);
				const total = rental + pickupLocPrice + returnLocPrice;
				(totalInput as HTMLInputElement).value = total.toFixed(2);
			}

			// Attach listeners
			scooterSelect?.addEventListener('change', calcTotal);
			pickupDateInput?.addEventListener('change', calcTotal);
			returnDateInput?.addEventListener('change', calcTotal);
			pickupSelect?.addEventListener('change', calcTotal);
			returnSelect?.addEventListener('change', calcTotal);

			// Load bookings table
			const bookRes = await fetch('/api/bookings', { credentials: 'include' });
			if (!bookRes.ok) {
				tbody.innerHTML = '<tr><td colspan="6">Failed to load bookings.</td></tr>';
			} else {
				const bookings = await bookRes.json();
				tbody.innerHTML = bookings.length === 0
					? '<tr><td colspan="6">No bookings yet.</td></tr>'
					: bookings.map((b) => `
						<tr>
							<td>${escapeHtml(b.customerName ?? '')}</td>
							<td>${escapeHtml(b.scooterId ?? '')}</td>
							<td>${escapeHtml(b.pickupDate ?? '')}</td>
							<td>${escapeHtml(b.returnDate ?? '')}</td>
							<td>€${Number(b.totalEur ?? 0).toFixed(2)}</td>
							<td>${escapeHtml(b.status ?? '')}</td>
						</tr>
					`).join('');
			}

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				formMsg.textContent = '';
				const emailVal = (document.getElementById('booking-email') as HTMLInputElement)?.value?.trim() ?? '';
				const phoneVal = (document.getElementById('booking-phone') as HTMLInputElement)?.value?.trim() ?? '';
				if (!emailVal && !phoneVal) {
					formMsg.textContent = 'Email or phone is required.';
					return;
				}
				const fd = new FormData(form);
				const body = {
					customerName: fd.get('customerName'),
					email: fd.get('email'),
					phone: fd.get('phone'),
					scooterId: fd.get('scooterId'),
					pickupDate: fd.get('pickupDate'),
					returnDate: fd.get('returnDate'),
					pickupLocationId: fd.get('pickupLocationId'),
					returnLocationId: fd.get('returnLocationId'),
					totalEur: parseFloat(String(fd.get('totalEur') ?? 0)) || 0,
					status: fd.get('status') || 'pending',
					notes: fd.get('notes'),
				};
				const res = await fetch('/api/bookings', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(body),
				});
				const data = await res.json().catch(() => ({}));
				if (res.ok) {
					formMsg.textContent = 'Booking created.';
					form.reset();
					window.location.reload();
				} else {
					formMsg.textContent = data.error || 'Failed to create booking.';
				}
			});
		})();
	</script>
</DashboardLayout>
