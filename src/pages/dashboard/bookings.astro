---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---
<DashboardLayout title="Bookings">
	<h1>Bookings</h1>
	<div class="dash-card">
		<h2 style="margin-top: 0; font-size: 1.1rem;">New booking</h2>
		<form id="booking-form" class="dash-form booking-form-grid">
			<div class="dash-field">
				<label>Customer name</label>
				<input type="text" name="customerName" required />
			</div>
			<div class="dash-field">
				<label>Email</label>
				<input type="email" name="email" id="booking-email" />
			</div>
			<div class="dash-field">
				<label>Phone</label>
				<input type="text" name="phone" id="booking-phone" />
			</div>
			<div class="dash-field">
				<label>Boat</label>
				<select name="boatId" id="booking-boat"></select>
			</div>
			<div class="dash-field">
				<label>Rental date</label>
				<input type="date" name="rentalDate" id="booking-rental-date" required />
			</div>
			<div class="dash-field">
				<label>Duration</label>
				<select name="duration" id="booking-duration">
					<option value="4h">4h</option>
					<option value="7h">7h</option>
				</select>
			</div>
			<div class="dash-field">
				<label>Meet location</label>
				<select name="locationId" id="booking-location">
					<option value="">—</option>
				</select>
			</div>
			<div class="dash-field">
				<label>Total (€)</label>
				<input type="number" name="totalEur" id="booking-total" step="0.01" min="0" value="0" />
			</div>
			<div class="dash-field">
				<label>Status</label>
				<select name="status">
					<option value="pending">Pending</option>
					<option value="completed">Completed</option>
					<option value="cancelled">Cancelled</option>
				</select>
			</div>
			<div class="dash-field" style="grid-column: 1 / -1;">
				<label>Notes</label>
				<textarea name="notes" style="max-width: 100%;"></textarea>
			</div>
			<div style="grid-column: 1 / -1;">
				<button type="submit" class="dash-btn">Create booking</button>
			</div>
		</form>
		<p id="booking-form-msg" style="margin-top: 0.75rem; font-size: 0.9rem; color: #666;"></p>
	</div>
	<style>
		.booking-form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 0.75rem 1.25rem;
		}
		.booking-form-grid .dash-field {
			margin-bottom: 0;
		}
		.booking-form-grid input,
		.booking-form-grid select,
		.booking-form-grid textarea {
			max-width: 100%;
		}
	</style>
	<div class="dash-card">
		<h2 style="margin-top: 0; font-size: 1.1rem;">All bookings</h2>
		<table class="dash-table" id="bookings-table">
			<thead>
				<tr>
					<th>Customer</th>
					<th>Boat</th>
					<th>Date</th>
					<th>Duration</th>
					<th>Total</th>
					<th>Status</th>
				</tr>
			</thead>
			<tbody id="bookings-tbody">
				<tr><td colspan="6">Loading…</td></tr>
			</tbody>
		</table>
	</div>
	<script>
		function escapeHtml(s: string) {
			const div = document.createElement('div');
			div.textContent = s ?? '';
			return div.innerHTML;
		}

		function getLocationPrice(locations: Array<{ id: string; price_eur?: number | null }>, locationId: string) {
			if (!locationId) return 0;
			const loc = locations.find((l: { id: string }) => l.id === locationId);
			return (loc && loc.price_eur != null) ? Number(loc.price_eur) : 0;
		}

		(async () => {
			const form = document.getElementById('booking-form') as HTMLFormElement | null;
			const formMsg = document.getElementById('booking-form-msg');
			const tbody = document.getElementById('bookings-tbody');
			const boatSelect = document.getElementById('booking-boat') as HTMLSelectElement | null;
			const locationSelect = document.getElementById('booking-location') as HTMLSelectElement | null;
			const totalInput = document.getElementById('booking-total') as HTMLInputElement | null;
			const durationSelect = document.getElementById('booking-duration') as HTMLSelectElement | null;

			let boats: Array<{ id: string; name: string; price4h?: number; price7h?: number }> = [];
			let locations: Array<{ id: string; label?: string; price_eur?: number | null }> = [];

			// Load boats
			const boatsRes = await fetch('/api/boats', { credentials: 'include' });
			if (boatsRes.ok) {
				boats = await boatsRes.json();
				if (boatSelect) boatSelect.innerHTML = '<option value="">Select boat</option>' + boats.map((b) => `<option value="${escapeHtml(b.id)}">${escapeHtml(b.name)}</option>`).join('');
			}

			// Load locations
			const locRes = await fetch('/api/locations', { credentials: 'include' });
			if (locRes.ok) {
				locations = await locRes.json();
				locations.forEach((loc) => {
					const opt = document.createElement('option');
					opt.value = loc.id;
					opt.textContent = loc.label || loc.id;
					locationSelect?.appendChild(opt);
				});
			}

			function calcTotal() {
				if (!totalInput || !boatSelect || !durationSelect || !locationSelect) return;
				const boatId = boatSelect.value;
				const duration = durationSelect.value;
				const locationId = locationSelect.value;
				const boat = boats.find((b) => b.id === boatId);
				let total = 0;
				if (boat) {
					total = duration === '7h' ? (Number(boat.price7h) || 0) : (Number(boat.price4h) || 0);
				}
				total += getLocationPrice(locations, locationId);
				totalInput.value = total.toFixed(2);
			}

			boatSelect?.addEventListener('change', calcTotal);
			durationSelect?.addEventListener('change', calcTotal);
			locationSelect?.addEventListener('change', calcTotal);

			function boatName(boatId: string) {
				const b = boats.find((x) => x.id === boatId);
				return b ? b.name : (boatId || '—');
			}

			// Load bookings table
			const bookRes = await fetch('/api/bookings', { credentials: 'include' });
			if (!tbody) return;
			if (!bookRes.ok) {
				tbody.innerHTML = '<tr><td colspan="6">Failed to load bookings.</td></tr>';
			} else {
				const bookings = await bookRes.json();
				tbody.innerHTML = bookings.length === 0
					? '<tr><td colspan="6">No bookings yet.</td></tr>'
					: bookings.map((b: { boatId?: string; scooterId?: string; rentalDate?: string; pickupDate?: string; duration?: string; customerName?: string; totalEur?: number; status?: string }) => {
						const date = b.rentalDate ?? b.pickupDate ?? '—';
						const boatLabel = boatName(b.boatId ?? b.scooterId ?? '');
						const durationLabel = b.duration ?? '—';
						return `
						<tr>
							<td>${escapeHtml(b.customerName ?? '')}</td>
							<td>${escapeHtml(boatLabel)}</td>
							<td>${escapeHtml(date)}</td>
							<td>${escapeHtml(durationLabel)}</td>
							<td>€${Number(b.totalEur ?? 0).toFixed(2)}</td>
							<td>${escapeHtml(b.status ?? '')}</td>
						</tr>
					`;
					}).join('');
			}

			if (!form || !formMsg) return;
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				formMsg.textContent = '';
				const emailVal = (document.getElementById('booking-email') as HTMLInputElement)?.value?.trim() ?? '';
				const phoneVal = (document.getElementById('booking-phone') as HTMLInputElement)?.value?.trim() ?? '';
				if (!emailVal && !phoneVal) {
					formMsg.textContent = 'Email or phone is required.';
					return;
				}
				const fd = new FormData(form);
				const body = {
					customerName: fd.get('customerName'),
					email: fd.get('email'),
					phone: fd.get('phone'),
					boatId: fd.get('boatId'),
					rentalDate: fd.get('rentalDate'),
					duration: fd.get('duration') || '4h',
					locationId: fd.get('locationId') || '',
					totalEur: parseFloat(String(fd.get('totalEur') ?? 0)) || 0,
					status: fd.get('status') || 'pending',
					notes: fd.get('notes'),
				};
				const res = await fetch('/api/bookings', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(body),
				});
				const data = await res.json().catch(() => ({}));
				if (res.ok) {
					formMsg.textContent = 'Booking created.';
					form.reset();
					window.location.reload();
				} else {
					formMsg.textContent = (data as { error?: string }).error || 'Failed to create booking.';
				}
			});
		})();
	</script>
</DashboardLayout>
