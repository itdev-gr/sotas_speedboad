---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---
<DashboardLayout title="Prices">
	<h1>Prices</h1>
	<div class="dash-card">
		<p>Prices per day by scooter and season. Rows: 1–7 days. Save updates all visible cells.</p>
		<div id="prices-container">Loading…</div>
		<div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
			<button type="button" class="dash-btn" id="prices-save">Save all</button>
			<button type="button" class="dash-btn" id="prices-init">Initialize prices</button>
		</div>
		<p id="prices-msg" style="margin-top: 0.75rem; font-size: 0.9rem; color: #666;"></p>
	</div>
	<script>
		const SCOOTERS = [
			{ id: 'sh-125', label: 'SH 125' },
			{ id: 'liberty-125', label: 'LIBERTY 125' },
			{ id: 'sim-200', label: 'SIM 200' },
			{ id: 'voge-rally-300', label: 'VOGE RALLY 300' },
		];
		const SEASONS = ['low', 'high'];
		(async () => {
			const container = document.getElementById('prices-container');
			const saveBtn = document.getElementById('prices-save');
			const initBtn = document.getElementById('prices-init');
			const msg = document.getElementById('prices-msg');

			const res = await fetch('/api/prices', { credentials: 'include' });
			if (!res.ok) {
				container.innerHTML = 'Failed to load prices.';
				return;
			}
			const pricesList = await res.json();
			const priceMap = new Map();
			pricesList.forEach((p) => priceMap.set(`${p.scooter_id}_${p.season}_${p.days}`, p.price_eur));

			let html = '';
			for (const season of SEASONS) {
				html += `<h3 style="margin: 1rem 0 0.5rem;">Season: ${season}</h3>`;
				html += '<table class="dash-table"><thead><tr><th>Scooter</th>';
				for (let d = 1; d <= 7; d++) html += `<th>${d} day(s)</th>`;
				html += '</tr></thead><tbody>';
				for (const scooter of SCOOTERS) {
					html += `<tr><td>${scooter.label}</td>`;
					for (let days = 1; days <= 7; days++) {
						const key = `${scooter.id}_${season}_${days}`;
						const val = priceMap.get(key) ?? '';
						html += `<td><input type="number" min="0" step="0.01" data-key="${key}" value="${val}" style="width: 70px;" /></td>`;
					}
					html += '</tr>';
				}
				html += '</tbody></table>';
			}
			container.innerHTML = html;

			saveBtn.addEventListener('click', async () => {
				const inputs = container.querySelectorAll('input[data-key]');
				const items = [];
				inputs.forEach((input) => {
					const key = (input as HTMLInputElement).getAttribute('data-key');
					if (!key) return;
					const [scooterId, season, daysStr] = key.split('_');
					const days = parseInt(daysStr, 10);
					const priceEur = parseFloat((input as HTMLInputElement).value) || 0;
					items.push({ scooter_id: scooterId, season, days, price_eur: priceEur });
				});
				msg.textContent = '';
				const putRes = await fetch('/api/prices', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(items),
				});
				if (putRes.ok) msg.textContent = 'Saved.';
				else msg.textContent = 'Failed to save.';
			});

			initBtn?.addEventListener('click', async () => {
				const items: { scooter_id: string; season: string; days: number; price_eur: number }[] = [];
				for (const scooter of SCOOTERS) {
					for (const season of SEASONS) {
						for (let days = 1; days <= 7; days++) {
							items.push({ scooter_id: scooter.id, season, days, price_eur: 0 });
						}
					}
				}
				msg.textContent = '';
				const putRes = await fetch('/api/prices', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(items),
				});
				if (putRes.ok) {
					msg.textContent = 'Prices initialized. You can edit the grid and click Save all.';
					location.reload();
				} else {
					msg.textContent = 'Failed to initialize.';
				}
			});
		})();
	</script>
</DashboardLayout>
